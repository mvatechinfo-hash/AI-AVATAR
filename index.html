<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI-AVATAR</title>

    <!-- Tailwind CSS for modern styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    
    <!-- Custom CSS for layout and aesthetics -->
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;700&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            margin: 0;
            background: #111827;
            overflow: hidden;
            display: flex;
            justify-content: center;
            align-items: center;
            color: #e5e7eb;
        }
        canvas {
            display: block;
            touch-action: none;
        }
        .chat-ui-container {
            position: absolute;
            top: 20px;
            right: 20px;
            bottom: 20px;
            padding: 1rem;
            width: 100%;
            max-width: 400px;
            z-index: 10;
            display: flex;
            flex-direction: column;
            background-color: rgba(31, 41, 55, 0.9); /* Semi-transparent dark background */
            border-radius: 1rem;
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.2);
            backdrop-filter: blur(5px);
        }
        .chat-messages {
            flex-grow: 1;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
            padding-right: 0.5rem;
        }
        .message {
            max-width: 80%;
            padding: 0.5rem 1rem;
            border-radius: 1rem;
        }
        .message-user {
            align-self: flex-end;
            background-color: #3b82f6; /* Blue for user */
            color: white;
            border-bottom-right-radius: 0;
        }
        .message-avatar {
            align-self: flex-start;
            background-color: #4b5563; /* Gray for avatar */
            color: white;
            border-bottom-left-radius: 0;
        }
        .input-area {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-top: 1rem;
        }
        .input-area textarea {
            background-color: #1f2937;
            border: 1px solid #4b5563;
            color: #e5e7eb;
            resize: none;
            height: 40px;
            overflow: hidden;
        }
        .send-button {
            transition: transform 0.2s;
        }
        .send-button:hover {
            transform: scale(1.05);
        }
        .loading-indicator {
            align-self: flex-start;
            padding: 0.5rem 1rem;
        }
        .system-message {
            text-align: center;
            font-size: 0.875rem;
            color: #9ca3af;
        }
        
        .loading-animation {
            display: flex;
            align-items: center;
            gap: 0.25rem;
        }
        .loading-dot {
            width: 8px;
            height: 8px;
            background-color: #9ca3af;
            border-radius: 50%;
            animation: bounce 1.4s infinite ease-in-out both;
        }
        .loading-dot:nth-child(1) { animation-delay: -0.32s; }
        .loading-dot:nth-child(2) { animation-delay: -0.16s; }
        @keyframes bounce {
            0%, 80%, 100% { transform: scale(0); }
            40% { transform: scale(1); }
        }
        
        /* Modal for error messages */
        .modal {
            display: none;
            position: fixed;
            z-index: 100;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.4);
            justify-content: center;
            align-items: center;
        }
        .modal-content {
            background-color: #1f2937;
            margin: auto;
            padding: 20px;
            border: 1px solid #888;
            width: 80%;
            max-width: 500px;
            border-radius: 0.5rem;
            text-align: center;
        }
        .close-button {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
        }
        .close-button:hover,
        .close-button:focus {
            color: black;
            text-decoration: none;
            cursor: pointer;
        }
    </style>

    <!-- Three.js for 3D rendering -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/loaders/GLTFLoader.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/controls/OrbitControls.js"></script>
</head>
<body>
    <div id="modal" class="modal">
        <div class="modal-content">
            <span class="close-button" onclick="closeModal()">&times;</span>
            <p id="modal-message"></p>
        </div>
    </div>
    
    <div class="chat-ui-container">
        <div class="flex items-center justify-between p-4 border-b border-gray-700">
            <h1 class="text-xl font-bold">Chat with AI Avatar</h1>
            <i class="fas fa-robot text-gray-400"></i>
        </div>
        <div class="chat-messages" id="chat-messages">
            <div class="system-message">
                <p>Welcome! Ask me anything.</p>
            </div>
            <!-- Chat messages will be appended here -->
        </div>
        <div class="input-area">
            <textarea id="chat-input" class="flex-grow rounded-lg p-2" placeholder="Type a message..." rows="1"></textarea>
            <button id="send-button" class="bg-blue-600 text-white p-2 rounded-full w-10 h-10 flex items-center justify-center shadow-lg hover:bg-blue-500 send-button">
                <i class="fas fa-paper-plane"></i>
            </button>
        </div>
    </div>

    <!-- Main script for the 3D scene and chat logic -->
    <script type="module">
        // Import Three.js modules (already loaded via CDN)
        // This is for clarity, but not strictly needed due to global scope from CDN
        // import * as THREE from 'https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js';
        // import { GLTFLoader } from 'https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/loaders/GLTFLoader.js';
        // import { OrbitControls } from 'https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/controls/OrbitControls.js';

        // --- Global Variables ---
        let scene, camera, renderer, avatar, mixer;
        let animations, animationActions = {};
        let activeAction;
        let jawBone;
        let isTalking = false;
        let chatHistory = [];
        let isMoving = false;
        let isTurning = false;
        let targetQuaternion = new THREE.Quaternion();
        let turnStartTime = 0;
        const turnDuration = 1000;
        let audioContext;
        let sourceNode;
        let lastInteractionTime = Date.now();
        const idleTimeout = 30000; // 30 seconds

        const animationNames = {
            idle: 'idle',
            idle2: 'idle-2',
            speaking: 'talking',
            walk: 'walk',
            wave: 'wave'
        };
        
        // --- Modal Functions ---
        function showModal(message) {
            document.getElementById('modal-message').innerText = message;
            document.getElementById('modal').style.display = 'flex';
        }

        function closeModal() {
            document.getElementById('modal').style.display = 'none';
        }

        // --- Core Application Logic ---
        
        /**
         * Initializes the Three.js scene, camera, renderer, and lighting.
         */
        function init() {
            // Scene setup
            scene = new THREE.Scene();
            scene.background = new THREE.Color(0x111827);

            // Camera setup
            camera = new THREE.PerspectiveCamera(45, window.innerWidth / window.innerHeight, 0.1, 1000);
            camera.position.set(0, 1.5, 3);
            camera.lookAt(0, 1.2, 0);

            // Renderer setup
            renderer = new THREE.WebGLRenderer({ antialias: true });
            renderer.setSize(window.innerWidth, window.innerHeight);
            renderer.setPixelRatio(window.devicePixelRatio);
            renderer.outputEncoding = THREE.sRGBEncoding;
            renderer.toneMapping = THREE.ACESFilmicToneMapping;
            renderer.shadowMap.enabled = true;
            document.body.appendChild(renderer.domElement);

            // Lighting
            const ambientLight = new THREE.AmbientLight(0xffffff, 0.8);
            scene.add(ambientLight);
            const directionalLight = new THREE.DirectionalLight(0xffffff, 1.2);
            directionalLight.position.set(1, 2, 1);
            directionalLight.castShadow = true;
            scene.add(directionalLight);
            
            // OrbitControls for camera interaction
            const controls = new THREE.OrbitControls(camera, renderer.domElement);
            controls.target.set(0, 1.2, 0);
            controls.update();

            // Load the avatar model
            loadAvatar();

            // Handle window resizing
            window.addEventListener('resize', onWindowResize, false);

            // Setup input event listeners
            setupInputListeners();

            // Initialize audio context
            try {
                audioContext = new (window.AudioContext || window.webkitAudioContext)();
            } catch (e) {
                console.error('Web Audio API is not supported in this browser:', e);
                showModal('Web Audio API is not supported in this browser.');
            }
        }

        /**
         * Loads the 3D avatar model from a public GLTF URL.
         */
        function loadAvatar() {
            const loader = new THREE.GLTFLoader();
            // A public domain avatar model for demonstration
            loader.load('https://raw.githubusercontent.com/ajay-goel-22/3D-Model-for-AI-Avatar/main/Stacy.glb', function(gltf) {
                avatar = gltf.scene;
                avatar.scale.set(1.2, 1.2, 1.2);
                avatar.position.y = -0.5;
                avatar.traverse(node => {
                    if (node.isMesh) {
                        node.castShadow = true;
                        node.receiveShadow = true;
                    }
                    // Find the jaw bone for lip-syncing
                    if (node.isBone && node.name === 'mixamorigJaw') {
                        jawBone = node;
                    }
                });
                scene.add(avatar);
                
                // Set up animations
                mixer = new THREE.AnimationMixer(avatar);
                animations = gltf.animations;
                
                // Create actions for each animation
                animations.forEach(clip => {
                    const action = mixer.clipAction(clip);
                    animationActions[clip.name] = action;
                });
                
                // Start with an idle animation
                playAction(animationNames.idle2, THREE.LoopRepeat);
                
                // Start the animation loop
                animate();

            }, undefined, function(error) {
                console.error('An error occurred loading the GLTF model:', error);
                showModal('Failed to load avatar model. Please try again later.');
            });
        }
        
        /**
         * Plays a specified animation action.
         * @param {string} name - The name of the animation to play.
         * @param {number} loopMode - The looping mode for the animation (e.g., THREE.LoopRepeat).
         */
        function playAction(name, loopMode) {
            const newAction = animationActions[name];
            if (!newAction) {
                console.warn(`Animation action "${name}" not found.`);
                return;
            }

            if (activeAction) {
                // Cross-fade to the new animation
                activeAction.fadeOut(0.5);
                newAction.reset().fadeIn(0.5).play();
            } else {
                newAction.play();
            }
            newAction.setLoop(loopMode);
            activeAction = newAction;
        }

        /**
         * Converts base64 encoded PCM audio data to a WAV Blob.
         * @param {string} base64 - Base64 encoded audio data.
         * @param {number} sampleRate - The sample rate of the audio.
         * @returns {Blob} A WAV audio blob.
         */
        function pcmToWav(base64, sampleRate) {
            const pcmData = atob(base64);
            const pcmBuffer = new ArrayBuffer(pcmData.length);
            const pcmView = new DataView(pcmBuffer);
            for (let i = 0; i < pcmData.length; ++i) {
                pcmView.setUint8(i, pcmData.charCodeAt(i));
            }

            const header = new ArrayBuffer(44);
            const view = new DataView(header);

            // RIFF identifier
            writeString(view, 0, 'RIFF');
            // file length
            view.setUint32(4, 36 + pcmData.length, true);
            // RIFF type
            writeString(view, 8, 'WAVE');
            // format chunk identifier
            writeString(view, 12, 'fmt ');
            // format chunk length
            view.setUint32(16, 16, true);
            // sample format (1 = PCM)
            view.setUint16(20, 1, true);
            // channel count
            view.setUint16(22, 1, true);
            // sample rate
            view.setUint32(24, sampleRate, true);
            // byte rate (sample rate * block align)
            view.setUint32(28, sampleRate * 2, true);
            // block align (channel count * bytes per sample)
            view.setUint16(32,
